<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Deet Live</title>
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<style>
  body {
    margin: 8;
    display: flex;
    flex-direction: column;
    height: 100vh;
  }
</style>
</head>
<body style="font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; margin: 0px">
  <div id="popup" style="position: absolute; display: none; background-color: rgba(0, 0, 0, 0.5); width: 100vw; height: 100vh;">
    <div onclick='closePopup()' style="width: 100vw; height: 100vh; display: flex;">
      
    </div>
    <div style="position: absolute; left: calc(50% - 100px); top: calc(50% - 100px); width: 200px; height: 200px; background-color: #fff; border: 1px solid #000">
    
    <div style="display: flex; flex-direction: row; justify-content: space-around;">
    <p id="loginText" onclick="setLogin()" style="text-decoration: underline;">Login</p>
    <p id="signupText" onclick="setSignup()">Signup</p>
  
  </div>
  
   <div id="usernameGroup" style="display: none; margin: 0; padding: 0">
  <label>Username</label>
  <input id="usernameInput"/>
</div>
  <label>Phone #</label>
  <input id="phoneInput"/>
  
  <label>Password</label>
  <input id="passwordInput"/>
  <button onclick="signup()" style="display: none" id="signupButton">Signup</button>

  <button onclick="login()" style="display: block" id="loginButton">Login</button>
  </div>
</div>
  <div style="margin: 0; width: 100%; display: flex; flex-direction: row; justify-content: space-between;">
  <p style="margin: 0; width: 100%;">Serenidad</p>
  <div style="display: flex; justify-content: space-between; width: 100%; flex-direction: row;">
    <a href="https://twitter.com/BldgSerenidad"><p style="margin: 0">Explore Streams</p></a>
    <p onclick="openPopup()" style="margin: 0">Sign In</p>
  </div>
</div>

  <div style="width: calc(100%); aspect-ratio: 16/9; position: relative">
  <video style="width: calc(100%); aspect-ratio: 16/9; border-bottom: #000 1px solid; border-top: #000 1px solid; display: inline" id="video" autoplay></video>
  <div style="position: absolute; display: flex; width: calc(100% - 2px); height: 100%; justify-content: center; align-items: center; left: 0; top: 0; margin: 0"> 
    <p style="margin: 0">Stream Offline</p>

  </div>
</div>

<p style="margin: 0; font-size: 44px">Deet Live Exploring South Carolina</p>

<div>
  <p style="margin-top: 8; margin-bottom: 8">Deet is live</p>
</div>

<p style="margin-top: 0">Interactions:</p>
<div>
<button onclick="fetchData()">surfers</button>
<button disabled>blur my vision</button>
<button disabled>jumpscare me</button>
<button disabled>shock me</button>

</div>

<p style="margin-top: 8; margin-bottom: 8">Chat:</p>
<div style="width: 100%; display: flex">
<input id="messageInput" style="width: 100%"/>
<button onclick="sendMessage()">Send</button>
</div>

<div id="messages">

</div>
<!-- <p>
  This was last week's stream:
</p> -->

<!-- 
<div style="width: 300px; aspect-ratio: 16/9; position: relative">
  <video src="https://cloud-q15kk69xc-hack-club-bot.vercel.app/0cdn.mp4" style="width: 300px; aspect-ratio: 16/9; border: #000 1px solid; display: inline" controls></video>
</div>
<p>
  Check out
  <a href="https://www.youtube.com/watch?v=PBqmPR7FE9Q&t=29s&pp=ygUSYnVpbGRpbmcgc2VyZW5pZGFk">full live stream here</a>

</p>
<p>Stream not working? email thomas:
  <a href="mailto:thomas@serenidad.app">thomas@serenidad.app</a>
  or
  <a href="mailto:thomas@serenidad.app">dieter@serenidad.app</a>

</p> -->
<script>
  var video = document.getElementById('video');
  
  // This function attempts to play the video and retries if it fails.
  function attemptPlay() {
    video.play().catch(() => {
      setTimeout(attemptPlay, 1000); // Retry after 1 second if initial play fails
    });
  }

  if(Hls.isSupported()) {
    var hls = new Hls();
    hls.loadSource('https://3b0e7ead606c.entrypoint.cloud.wowza.com/app-6Kf89806/ngrp:398ee5f6_all/playlist.m3u8');
    hls.attachMedia(video);
    hls.on(Hls.Events.MANIFEST_PARSED, function() {
      attemptPlay();
    });
  }
  else if (video.canPlayType('application/vnd.apple.mpegurl')) {
    video.src = 'https://3b0e7ead606c.entrypoint.cloud.wowza.com/app-6Kf89806/ngrp:398ee5f6_all/playlist.m3u8';
    video.addEventListener('loadedmetadata', attemptPlay);
  }

  // Listen for the 'ended' event and play the video again if it reaches the end.
  video.addEventListener('ended', () => {
    video.play();
  });
  function openPopup() {
    document.getElementById("popup").style.display = "flex"

  }
  function closePopup() {
    document.getElementById("popup").style.display = "none"

  }

  async function login() {
    var phone = encodeURIComponent(document.getElementById("phoneInput").value);
    var password = encodeURIComponent(document.getElementById("passwordInput").value);

    console.log(phone, password);
    const response = await fetch(`/login?phone=${phone}&password=${password}`, {
        method: 'GET'
    });
    const data = await response.json();
    console.log(data);

    // Check if the response contains a token and save it as a cookie
    if (data.token) {
        document.cookie = `token=${data.token}; path=/;`;  // Adjust the cookie attributes as needed
        closePopup()
      }
}


  async function signup() {

    var username = encodeURIComponent(document.getElementById("usernameInput").value)
    var phone = encodeURIComponent(document.getElementById("phoneInput").value)
    var password = encodeURIComponent(document.getElementById("passwordInput").value)

    console.log(username, phone, password)
    const response = await fetch(`/signup?username=${username}&phone=${phone}&password=${password}`, {
            method: 'GET'
        });
        const data = await response.json();
        console.log(data);

            // Check if the response contains a token and save it as a cookie
    if (data.token) {
        document.cookie = `token=${data.token}; path=/;`;  // Adjust the cookie attributes as needed
        closePopup()
      }
  }
  function setSignup() {
    document.getElementById("signupText").style.textDecoration = "underline"
    document.getElementById("loginText").style.textDecoration = "none"

    document.getElementById("signupButton").style.display = "block"
    document.getElementById("loginButton").style.display = "none"

    document.getElementById("usernameGroup").style.display = "block"


  }

  function setLogin() {
    document.getElementById("loginText").style.textDecoration = "underline"
    document.getElementById("signupText").style.textDecoration = "none"

    document.getElementById("loginButton").style.display = "block"
    document.getElementById("signupButton").style.display = "none"

    document.getElementById("usernameGroup").style.display = "none"

  }

  async function fetchData() {
    try {
      const response = await fetch('/sendInteraction');
      const data = await response.json();
      console.log(data);
    } catch (error) {
      console.error('Error fetching data:', error);
    }
  }

  async function sendMessage() {
    try {


        const message = document.getElementById("messageInput").value; // Example message
        const tokenCookie = document.cookie.split('; ').find(cookie => cookie.startsWith('token='));
        
        let token = '';
        if (tokenCookie) {
            token = tokenCookie.split('=')[1]; // Extract just the token value
        }

        if(token == "") {
          openPopup()
        }
        
        console.log(token);

        const encodedMessage = encodeURIComponent(message); // Encode the message to ensure it is URL-safe
        const response = await fetch(`/sendMessage?message=${encodedMessage}&token=${token}`, {
            method: 'GET'
        });
        const data = await response.json();
        console.log(data);
        document.getElementById("messageInput").value = "";
    } catch (error) {
        console.error('Error fetching data:', error);
    }
}






  // Function to fetch messages and update the div
  var lastData = null; // Cache the last fetched data to avoid unnecessary updates
  async function fetchMessages() {
    try {
      const response = await fetch('/getMessages');
      const data = await response.json();
      // Update the div only if there is new data
      if (JSON.stringify(data) !== JSON.stringify(lastData)) {
        lastData = data;
        const messagesDiv = document.getElementById('messages');
        messagesDiv.innerHTML = ''; // Clear previous messages
        data.forEach(msg => {

          const title = document.createElement('p');
          title.textContent = msg.sender;
          title.style.fontWeight = 600
          title.style.margin = 0

          messagesDiv.appendChild(title);

          const p = document.createElement('p');
          p.textContent = msg.message;
          p.style.margin = 0

          messagesDiv.appendChild(p);
        });
      }
    } catch (error) {
      console.error('Error fetching messages:', error);
    }
  }

  // Set up an interval to fetch messages every second
  setInterval(fetchMessages, 1000);
  
</script>

</body>
</html>
